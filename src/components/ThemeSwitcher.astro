---
import Icon from "./Icon.astro";
---

<button
  class="text-text-primary group transition-all"
  title="Toggle theme"
  id="theme-switcher"
  aria-label="Switch to dark mode"
  aria-pressed="false"
>
  <Icon
    class="pointer-events-none hidden h-7 w-7 group-hover:scale-110 group-active:scale-95 dark:block"
    name="heroicons-outline:sun"
    decorative={true}
  />
  <Icon
    class="pointer-events-none h-7 w-7 group-hover:scale-110 group-active:scale-95 dark:hidden"
    name="heroicons-outline:moon"
    decorative={true}
  />
</button>

<div
  id="theme-announcement"
  class="sr-only"
  role="status"
  aria-live="polite"
  aria-atomic="true"
>
</div>

<script is:inline>
  const updateTheme = (document, theme) => {
    const isDark = theme === "dark";
    document.documentElement.classList.toggle("dark", isDark);
    window.localStorage.setItem("theme", theme);

    // Update button attributes for accessibility
    const themeBtn = document.getElementById("theme-switcher");
    const announcement = document.getElementById("theme-announcement");
    if (themeBtn) {
      themeBtn.setAttribute(
        "aria-label",
        isDark ? "Switch to light mode" : "Switch to dark mode",
      );
      themeBtn.setAttribute("aria-pressed", isDark ? "true" : "false");
    }
    if (announcement) {
      announcement.textContent = `${isDark ? "Dark" : "Light"} mode enabled`;
    }
  };

  const setTheme = (document) => {
    const theme =
      localStorage.getItem("theme") ||
      (window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light");

    updateTheme(document, theme);
  };
  document.addEventListener("astro:before-swap", (ev) => {
    setTheme(ev.newDocument);
  });

  document.addEventListener(
    "astro:page-load",
    () => {
      setTheme(document);
    },
    { once: true },
  );

  document.addEventListener(
    "astro:page-load",
    () => {
      const themeBtn = document.getElementById("theme-switcher");

      themeBtn?.addEventListener("click", () => {
        const currentTheme = localStorage.getItem("theme");
        updateTheme(document, currentTheme === "light" ? "dark" : "light");
      });
    },
    { once: false },
  );
</script>
